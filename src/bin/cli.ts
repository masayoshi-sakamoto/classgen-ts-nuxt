import * as fs from 'fs'
import * as path from 'path'
import { Command } from 'commander'
import Generator from '../generator'

const pkg = require('../../package.json')
const commander = new Command()

commander
  .version(pkg.version)
  .option('--namespace <namespace>', 'application namespace')
  .option('-d, --dist <dist>', 'output directory')
  .option('-t, --type <type>', 'template type choices (web, admin)')
  .option('--auth [model]', 'authenticate flag', 'users')
  .option('-f, --force', 'output directory')

try {
  /**
   * 初期化処理
   */
  commander.command('initialize').action(() => {
    new Generator(commander.opts()).initialize()
  })

  /**
   * swaggerからentityなどを作成
   */
  commander
    .command('schema')
    .argument('<file>', 'mysql dump file')
    .option('-m, --model <model>', 'model name')
    .option('-e, --excludes <excludes>', 'excludes column', (items) => items.split(','))
    .action((file: string, options: { model: string; excludes: string }) => {
      console.log(options)
      if (!fs.existsSync(path.resolve(process.cwd(), file))) {
        throw new Error('File does not exist.')
      }
      const target = fs.readFileSync(path.resolve(process.cwd(), file), 'utf-8')
      new Generator(commander.opts()).schema(target, options)
    })

  /**
   * swaggerからentityなどを作成
   */
  commander.command('typegen').action(() => {
    new Generator(commander.opts()).typegen()
  })

  /**
   * swaggerファイルの生成
   */
  commander
    .command('swagger')
    .argument('<model>', 'generated by model name')
    .action((model: string) => {
      if (!model) {
        throw new Error('model is required.')
      }
      new Generator(commander.opts()).swagger(model)
    })

  /**
   * entity作成
   */
  commander
    .command('entity')
    .argument('<model>', 'generated by model name')
    .action((model: string) => {
      if (!model) {
        throw new Error('model is required.')
      }
      new Generator(commander.opts()).entity(model)
    })

  commander.parse(process.argv)
} catch (e) {
  console.error(e)
  process.exit(2)
}
